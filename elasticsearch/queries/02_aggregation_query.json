{
  "size": 0,
  "query": {
    "range": {
      "@timestamp": {
        "gte": "now-7d/d",
        "lte": "now/d"
      }
    }
  },
  "aggs": {
    "domains": {
      "terms": {
        "field": "domain",
        "size": 20,
        "order": {
          "_count": "desc"
        }
      },
      "aggs": {
        "avg_score": {
          "avg": {
            "field": "score"
          }
        },
        "avg_comments": {
          "avg": {
            "field": "comments_count"
          }
        },
        "max_score": {
          "max": {
            "field": "score"
          }
        },
        "top_stories": {
          "top_hits": {
            "size": 3,
            "sort": [
              {
                "score": {
                  "order": "desc"
                }
              }
            ],
            "_source": ["title", "score", "author"]
          }
        }
      }
    },
    "content_type_distribution": {
      "terms": {
        "field": "type",
        "size": 10
      },
      "aggs": {
        "avg_engagement": {
          "avg": {
            "field": "engagement_rate"
          }
        }
      }
    }
  }
}
