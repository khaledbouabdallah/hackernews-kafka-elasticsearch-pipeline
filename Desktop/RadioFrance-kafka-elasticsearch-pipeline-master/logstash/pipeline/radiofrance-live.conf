input {
  kafka {
    bootstrap_servers => "kafka:9092"
    topics => ["radiofrance-live"]
    codec => "json"
    consumer_threads => 1
    decorate_events => true
    group_id => "logstash-radiofrance"
  }
}

filter {
  # 1. On parse le message JSON
  json {
    source => "message"
    skip_on_invalid_json => true
  }

  # 2. Gestion de la géolocalisation pour France Bleu
  if [geo_location] {
    mutate {
      add_field => {
        "[location][lat]" => "%{[geo_location][lat]}"
        "[location][lon]" => "%{[geo_location][lon]}"
      }
    }
    mutate {
      convert => {
        "[location][lat]" => "float"
        "[location][lon]" => "float"
      }
      remove_field => ["geo_location"]
    }
  }

  # 3. Extraction des infos de l'émission
  if [current_show] {
    mutate {
      add_field => {
        "show_title" => "%{[current_show][show_title]}"
        "episode_title" => "%{[current_show][title]}"
        "show_url" => "%{[current_show][url]}"
      }
    }
    if [current_show][description] {
      mutate { add_field => { "description" => "%{[current_show][description]}" } }
    }
  }

  # 4. Extraction des thèmes (Ruby)
  if [themes] {
    ruby {
      code => "
        themes = event.get('themes')
        if themes && themes.is_a?(Array)
          event.set('theme_count', themes.length)
          categories = themes.map { |t| t.split('/').first }.uniq
          event.set('theme_categories', categories)
        end
      "
    }
  }

  # 5. Attribution de la marque de la station
  if [station_id] {
    if [station_id] =~ /^FRANCEINTER/ { mutate { add_field => { "station_brand" => "France Inter" } } }
    else if [station_id] =~ /^FRANCECULTURE/ { mutate { add_field => { "station_brand" => "France Culture" } } }
    else if [station_id] =~ /^FRANCEMUSIQUE/ { mutate { add_field => { "station_brand" => "France Musique" } } }
    else if [station_id] =~ /^FRANCEINFO/ { mutate { add_field => { "station_brand" => "France Info" } } }
    else if [station_id] =~ /^FIP/ { mutate { add_field => { "station_brand" => "FIP" } } }
    else if [station_id] =~ /^FRANCEBLEU/ { mutate { add_field => { "station_brand" => "France Bleu" } } }
    else if [station_id] =~ /^MOUV/ { mutate { add_field => { "station_brand" => "Mouv" } } }
  }

  # 6. Nettoyage final
  mutate {
    remove_field => ["@version", "message"]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "radiofrance-live-%{+YYYY.MM.dd}"
    document_id => "%{station_id}_%{snapshot_time}"
  }
  stdout { codec => rubydebug }
}