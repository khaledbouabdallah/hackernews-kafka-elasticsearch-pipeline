input {
  kafka {
    bootstrap_servers => "kafka:9092"
    topics => ["hackernews-stories"]
    codec => "json"
    group_id => "logstash-hn-consumer-group"
    consumer_threads => 1
    decorate_events => true
  }
}

filter {
  # Parse the story timestamp (already in ISO8601 from collector)
  date {
    match => ["created_at", "ISO8601"]
    target => "@timestamp"
  }

  # Extract author information
  if [author] {
    mutate {
      add_field => {
        "author_username" => "%{author}"
      }
    }
  }

  # Domain categorization and tagging
  if [domain] {
    mutate {
      add_field => {
        "domain_name" => "%{domain}"
      }
    }

    # Tag stories by domain type
    if [domain] =~ /github\.com/ {
      mutate { add_tag => ["github_story"] }
    } else if [domain] =~ /youtube\.com|youtu\.be/ {
      mutate { add_tag => ["video"] }
    } else if [domain] =~ /arxiv\.org/ {
      mutate { add_tag => ["research_paper"] }
    } else if [domain] =~ /medium\.com/ {
      mutate { add_tag => ["blog"] }
    } else if [domain] =~ /twitter\.com|x\.com/ {
      mutate { add_tag => ["social_media"] }
    }
  }

  # Content categorization (add tags based on type)
  if [type] == "ask" {
    mutate { add_tag => ["ask_hn"] }
  } else if [type] == "show" {
    mutate { add_tag => ["show_hn"] }
  } else if [type] == "job" {
    mutate { add_tag => ["job"] }
  } else if [type] == "story" {
    mutate { add_tag => ["regular_story"] }
  }

  # Score-based categorization
  if [score] {
    ruby {
      code => "
        score = event.get('score').to_i
        if score >= 500
          event.tag('trending')
          event.tag('high_score')
        elsif score >= 100
          event.tag('popular')
        elsif score >= 50
          event.tag('rising')
        end
      "
    }
  }

  # Engagement categorization
  if [comments_count] and [score] {
    ruby {
      code => "
        comments = event.get('comments_count').to_i
        score = event.get('score').to_i

        if comments > 100
          event.tag('high_engagement')
        elsif comments > 50
          event.tag('medium_engagement')
        end

        # Calculate engagement rate
        if score > 0
          engagement_rate = comments.to_f / score
          event.set('engagement_rate', engagement_rate.round(2))
        end
      "
    }
  }

  # Add processing metadata
  mutate {
    add_field => {
      "processed_at" => "%{@timestamp}"
      "pipeline_stage" => "logstash"
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "hackernews-stories-%{+YYYY.MM.dd}"
    document_id => "%{id}"
  }

  # Debugging output (optional, comment out in production)
  stdout {
    codec => rubydebug {
      metadata => true
    }
  }
}
